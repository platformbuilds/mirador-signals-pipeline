# Mirador Pipelines - Umbrella Chart
# Single helm install deploys the entire connected pipeline stack

# Global settings
global:
  # Default namespace for the stack (used in DNS hostnames)
  # To create namespace automatically, use: --create-namespace flag with helm install
  namespace: miradorstack

# Gateway Pipeline Configuration
gateway:
  enabled: true

  # Image configuration
  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  nameOverride: "gateway"
  mode: "deployment"
  replicaCount: 3

  # Enable RBAC for K8s service discovery in loadbalancing exporter
  clusterRole:
    create: true
    rules:
      - apiGroups: [""]
        resources: ["services", "endpoints"]
        verbs: ["get", "list", "watch"]

  # Gateway resources
  resources: {}

  # Gateway collector configuration
  config:
    exporters:
      # Use Case 1: Service Graph - Load Balanced (DEFAULT)
      loadbalancing/servicegraph:
        routing_key: "traceID"
        protocol:
          otlp:
            timeout: 10s
            tls:
              insecure: true
        resolver:
          k8s:
            service: "mirador-pipelines-servicegraph"
            ports:
              - 4317

      # Use Case 2: Span Metrics - Load Balanced (DEFAULT)
      loadbalancing/spanmetrics:
        routing_key: "traceID"
        protocol:
          otlp:
            timeout: 10s
            tls:
              insecure: true
        resolver:
          k8s:
            service: "mirador-pipelines-spanmetrics"
            ports:
              - 4317

      # Use Case 3: Application Metrics Anomaly Detection - Load Balanced (NEW)
      loadbalancing/isolationforest-metrics:
        routing_key: "resource"  # Route by resource attributes for consistent anomaly baselines
        protocol:
          otlp:
            timeout: 10s
            tls:
              insecure: true
        resolver:
          k8s:
            service: "mirador-pipelines-isolationforest"
            ports:
              - 4317

      # Fallback: Standard OTLP exporter for Service Graph (if loadbalancing disabled)
      otlp/servicegraph:
        endpoint: "mirador-pipelines-servicegraph.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

      # Fallback: Standard OTLP exporter for Span Metrics (if loadbalancing disabled)
      otlp/spanmetrics:
        endpoint: "mirador-pipelines-spanmetrics.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

      # Logs routing to VictoriaLogs (via adapter)
      otlp/logs:
        endpoint: "mirador-pipelines-vlogadapter.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true
        sending_queue:
          enabled: true
          num_consumers: 10

      # Metrics routing to VictoriaMetrics (via adapter)
      otlp/metrics:
        endpoint: "mirador-pipelines-vmadapter.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25

      batch/traces:
        timeout: 10s
        send_batch_size: 1024

      batch/logs:
        timeout: 1s
        send_batch_size: 10000

      batch/metrics:
        timeout: 60s
        send_batch_size: 8192

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318
      prometheus:
        config:
          scrape_configs:
            - job_name: opentelemetry-collector
              scrape_interval: 10s
              static_configs:
                - targets:
                    - ${env:MY_POD_IP}:8888

    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: ${env:MY_POD_IP}
                    port: 8888
      extensions:
        - health_check
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch/traces]
          exporters: [loadbalancing/servicegraph, loadbalancing/spanmetrics]  # Load-balanced fan-out to both use cases

        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch/logs]
          exporters: [otlp/logs]

        metrics:
          receivers: [otlp, prometheus]
          processors: [memory_limiter, batch/metrics]
          exporters: [loadbalancing/isolationforest-metrics]  # Single-export: All metrics through IsolationForest for anomaly detection

  # Port configuration - only OTLP needed for gateway
  ports:
    otlp:
      enabled: true
    otlp-http:
      enabled: true
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true

  # Disable all presets
  presets:
    logsCollection:
      enabled: false
    hostMetrics:
      enabled: false
    kubernetesAttributes:
      enabled: false
    kubeletMetrics:
      enabled: false
    kubernetesEvents:
      enabled: false
    clusterMetrics:
      enabled: false

  useGOMEMLIMIT: true

# Service Graph Collector Configuration
servicegraph:
  enabled: true

  # Image configuration
  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  nameOverride: "servicegraph"
  mode: "deployment"
  replicaCount: 1  # Must be 1 for complete service graph

  # Service Graph resources
  resources: {}

  # Service Graph collector configuration
  config:
    connectors:
      servicegraph:
        latency_histogram_buckets: [2ms, 4ms, 6ms, 8ms, 10ms, 50ms, 100ms, 200ms, 400ms, 800ms, 1s, 1400ms, 2s, 5s, 10s, 15s]
        dimensions:
          - http.method
          - http.status_code
          - rpc.grpc.status_code
        store:
          ttl: 2s
          max_items: 10000
        cache_loop: 60m
        store_expiration_loop: 10s

    exporters:
      otlp/traces:
        endpoint: "mirador-pipelines-victoriatraces-victoria-traces-cluster-vtinsert.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

      otlp/metrics:
        endpoint: "mirador-pipelines-vmadapter.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25

      batch/traces:
        timeout: 10s
        send_batch_size: 1024

      batch/metrics:
        timeout: 30s
        send_batch_size: 1000

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318

    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: ${env:MY_POD_IP}
                    port: 8888
      extensions:
        - health_check
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch/traces]
          exporters: [servicegraph, otlp/traces]

        metrics/servicegraph:
          receivers: [servicegraph]
          processors: [batch/metrics]
          exporters: [otlp/metrics]

  # Port configuration - only OTLP needed for service graph
  ports:
    otlp:
      enabled: true
    otlp-http:
      enabled: true
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true

  # Disable all presets
  presets:
    logsCollection:
      enabled: false
    hostMetrics:
      enabled: false
    kubernetesAttributes:
      enabled: false
    kubeletMetrics:
      enabled: false
    kubernetesEvents:
      enabled: false
    clusterMetrics:
      enabled: false

  useGOMEMLIMIT: true

# Span Metrics Collector Configuration (Use Case 2)
spanmetrics:
  enabled: true

  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  nameOverride: "spanmetrics"
  mode: "deployment"
  replicaCount: 1

  resources: {}

  config:
    connectors:
      spanmetrics:
        histogram:
          explicit:
            buckets: [2ms, 4ms, 6ms, 8ms, 10ms, 50ms, 100ms, 200ms, 400ms, 800ms, 1s, 1400ms, 2s, 5s, 10s, 15s, 30s]
        dimensions:
          - name: http.method
          - name: http.status_code
        exemplars:
          enabled: true
        metrics_expiration: 5m

    exporters:
      otlp/isolationforest:
        endpoint: "mirador-pipelines-isolationforest.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

      otlp/traces:
        endpoint: "mirador-pipelines-victoriatraces-victoria-traces-cluster-vtinsert.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25

      batch/traces:
        timeout: 10s
        send_batch_size: 1024

      batch/metrics:
        timeout: 30s
        send_batch_size: 1000

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318

    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: ${env:MY_POD_IP}
                    port: 8888
      extensions:
        - health_check
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch/traces]
          exporters: [spanmetrics, otlp/traces]

        metrics/spanmetrics:
          receivers: [spanmetrics]
          processors: [batch/metrics]
          exporters: [otlp/isolationforest]

  ports:
    otlp:
      enabled: true
    otlp-http:
      enabled: true
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true

  presets:
    logsCollection:
      enabled: false
    hostMetrics:
      enabled: false
    kubernetesAttributes:
      enabled: false
    kubeletMetrics:
      enabled: false
    kubernetesEvents:
      enabled: false
    clusterMetrics:
      enabled: false

  useGOMEMLIMIT: true

# Isolation Forest Processor Configuration (Use Case 2)
isolationforest:
  enabled: true

  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  nameOverride: "isolationforest"
  mode: "deployment"
  replicaCount: 3  # Scaled for HA and loadbalancing from gateway

  resources: {}

  config:
    exporters:
      otlp/metrics:
        endpoint: "mirador-pipelines-vmadapter.miradorstack.svc.cluster.local:4317"
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25

      # Isolation forest processor - minimal config for now
      # Configuration will be refined based on actual processor capabilities
      isolationforest: {}

      batch/metrics:
        timeout: 30s
        send_batch_size: 1000

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318

    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: ${env:MY_POD_IP}
                    port: 8888
      extensions:
        - health_check
      pipelines:
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, isolationforest, batch/metrics]
          exporters: [otlp/metrics]

  ports:
    otlp:
      enabled: true
    otlp-http:
      enabled: true
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true

  presets:
    logsCollection:
      enabled: false
    hostMetrics:
      enabled: false
    kubernetesAttributes:
      enabled: false
    kubeletMetrics:
      enabled: false
    kubernetesEvents:
      enabled: false
    clusterMetrics:
      enabled: false

  useGOMEMLIMIT: true

# VictoriaMetrics Cluster Configuration
victoriametrics:
  enabled: true

  vminsert:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8480
      type: ClusterIP
    resources: {}
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VM_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vminsert
              topologyKey: kubernetes.io/hostname

  vmselect:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8481
      type: ClusterIP
    resources: {}
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VM_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vmselect
              topologyKey: kubernetes.io/hostname

  vmstorage:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8482
      type: ClusterIP
    resources: {}
    persistentVolume:
      enabled: true
      size: 50Gi
      storageClass: "manual"
    retentionPeriod: "30d"
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VM_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vmstorage
              topologyKey: kubernetes.io/hostname

# VictoriaMetrics OTLP Adapter Configuration
vmadapter:
  enabled: true

  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  nameOverride: "vmadapter"
  mode: "deployment"
  replicaCount: 2

  resources: {}

  config:
    exporters:
      otlphttp/victoriametrics:
        endpoint: "http://mirador-pipelines-victoriametrics-victoria-metrics-cluster-vminsert.miradorstack.svc.cluster.local:8480/insert/0/opentelemetry"
        tls:
          insecure: true
        compression: gzip
        encoding: proto

    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25
      batch:
        timeout: 60s
        send_batch_size: 8192

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318

    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: ${env:MY_POD_IP}
                    port: 8888
      extensions:
        - health_check
      pipelines:
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp/victoriametrics]

  ports:
    otlp:
      enabled: true
    otlp-http:
      enabled: true
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true

  presets:
    logsCollection:
      enabled: false
    hostMetrics:
      enabled: false
    kubernetesAttributes:
      enabled: false
    kubeletMetrics:
      enabled: false
    kubernetesEvents:
      enabled: false
    clusterMetrics:
      enabled: false

  useGOMEMLIMIT: true

# VictoriaTraces Cluster Configuration
victoriatraces:
  enabled: true

  vtinsert:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8480
      type: ClusterIP
    resources: {}
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VT_"
      loggerFormat: "json"
      otlpGRPCListenAddr: ":4317"
      otlpGRPC.tls: "false"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vtinsert
              topologyKey: kubernetes.io/hostname

  vtselect:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8481
      type: ClusterIP
    resources: {}
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VT_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vtselect
              topologyKey: kubernetes.io/hostname

  vtstorage:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8482
      type: ClusterIP
    resources: {}
    persistentVolume:
      enabled: true
      size: 50Gi
      storageClass: "manual"
    retentionPeriod: "30d"
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VT_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vtstorage
              topologyKey: kubernetes.io/hostname

# VictoriaLogs Cluster Configuration
victorialogs:
  enabled: true

  vlinsert:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 8429
      type: ClusterIP
    resources: {}
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VL_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vlinsert
              topologyKey: kubernetes.io/hostname

  vlselect:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 9471
      type: ClusterIP
    resources: {}
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VL_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vlselect
              topologyKey: kubernetes.io/hostname

  vlstorage:
    enabled: true
    replicaCount: 3
    service:
      servicePort: 9472
      type: ClusterIP
    resources: {}
    persistentVolume:
      enabled: true
      size: 100Gi
      storageClass: "manual"
    retentionPeriod: "30d"
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: "VL_"
      loggerFormat: "json"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - vlstorage
              topologyKey: kubernetes.io/hostname

# VictoriaLogs OTLP Adapter Configuration
vlogadapter:
  enabled: true

  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  nameOverride: "vlogadapter"
  mode: "deployment"
  replicaCount: 2

  resources: {}

  config:
    exporters:
      otlphttp/victorialogs:
        endpoint: "http://mirador-pipelines-victorialogs-victoria-logs-cluster-vlinsert.miradorstack.svc.cluster.local:8429/insert/opentelemetry/v1/logs"
        tls:
          insecure: true
        compression: gzip

    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25
      batch:
        timeout: 1s
        send_batch_size: 10000

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318

    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: ${env:MY_POD_IP}
                    port: 8888
      extensions:
        - health_check
      pipelines:
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp/victorialogs]

  ports:
    otlp:
      enabled: true
    otlp-http:
      enabled: true
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true

  presets:
    logsCollection:
      enabled: false
    hostMetrics:
      enabled: false
    kubernetesAttributes:
      enabled: false
    kubeletMetrics:
      enabled: false
    kubernetesEvents:
      enabled: false
    clusterMetrics:
      enabled: false

  useGOMEMLIMIT: true
